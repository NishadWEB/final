<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Appointments - MediDiag</title>
    <link rel="stylesheet" href="/main/main.css">
    <link rel="stylesheet" href="/navbar/navbar.css">
    <link rel="stylesheet" href="/doctor/dashboard.css">
</head>
<body>
    <%- include('../headers/preloginheader') %>
    
    <div class="container doctor-dashboard">
        <div class="dashboard-grid">
            <aside class="sidebar">
                <nav class="sidebar-nav">
                    <ul>
                        <li><a href="/doctor/dashboard">Dashboard</a></li>
                        <li><a href="/doctor/appointments" class="active">Appointments</a></li>
                        <li><a href="/doctor/profile">Profile</a></li>
                        <li><a href="/auth/logout">Logout</a></li>
                    </ul>
                </nav>
            </aside>

            <main class="dashboard-content">
                <h1>My Appointments</h1>
                
                <div class="appointments-filters">
                    <select id="status-filter" class="form-control" style="max-width: 200px;">
                        <option value="all">All Appointments</option>
                        <option value="scheduled">Scheduled</option>
                        <option value="completed">Completed</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                </div>

                <div class="appointments-list">
                    <% if (appointments.length > 0) { %>
                        <% appointments.forEach(appointment => { %>
                            <div class="card appointment-card" data-status="<%= appointment.status %>">
                                <div class="appointment-header">
                                    <div>
                                        <h3><%= appointment.patient_name %></h3>
                                        <p class="patient-contact">Phone: <%= appointment.patient_phone %></p>
                                    </div>
                                    <div class="appointment-status status-<%= appointment.status %>">
                                        <%= appointment.status %>
                                    </div>
                                </div>
                                
                                <div class="appointment-details">
                                    <p><strong>Date & Time:</strong> <%= new Date(appointment.appointment_date).toLocaleString() %></p>
                                    <p><strong>Symptoms:</strong> <%= appointment.symptoms %></p>
                                    <% if (appointment.preliminary_diagnosis) { %>
                                        <p><strong>Preliminary Diagnosis:</strong> <%= appointment.preliminary_diagnosis %></p>
                                    <% } %>
                                </div>
                                
                                <div class="appointment-actions">
                                    <% if (appointment.status === 'scheduled' || appointment.status === 'rescheduled' ) { %>
                                        <button class="btn btn-outline" data-id="<%= appointment.id %>" onclick="completeAppointment(this.dataset.id)">Mark Complete</button>
                                    <% } %>
                                   
                                </div>
                            </div>
                        <% }); %>
                    <% } else { %>
                        <div class="card" style="text-align: center; padding: 60px 40px;">
                            <h3>No Appointments</h3>
                            <p>You don't have any appointments scheduled yet.</p>
                        </div>
                    <% } %>
                </div>
            </main>
        </div>
    </div>

    <script>
        function viewAppointment(appointmentId) {
            // In real app, open appointment details modal
            alert('Appointment details would open for ID: ' + appointmentId);
        }

        async function completeAppointment(appointmentId) {
                const confirmed = confirm("Mark this appointment as completed?");
                if (!confirmed) return;

                try {
                    const response = await fetch(`/doctor/appointments/${appointmentId}/complete`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        }
                    });

                    const data = await response.json();

                    if (!data.success) {
                      alert("Failed to complete appointment.");
                     return;
                    }       

                    alert("Appointment marked as completed!");

                    // Update UI without reloading
                    const card = document.querySelector(`button[data-id='${appointmentId}']`).closest(".appointment-card");

                    // Update the status badge
                    const statusBadge = card.querySelector(".appointment-status");
                    statusBadge.innerText = "completed";
                    statusBadge.classList.remove("status-scheduled");
                    statusBadge.classList.add("status-completed");

                    // Remove old buttons and keep only "View Details"
                    const actions = card.querySelector(".appointment-actions");
                    actions.innerHTML = "";
                    // <button class="btn btn-outline" data-id="${appointmentId}" onclick="viewAppointment(this.dataset.id)">
                    //     View Details
                    // </button>
                    // `;

                    // Update dataset for filtering
                    card.dataset.status = "completed";

                } catch (err) {
                    console.error(err);
                    alert("Server error occurred.");
                }           
            }

        // Filter appointments by status
        document.getElementById('status-filter').addEventListener('change', function() {
            const status = this.value;
            const appointments = document.querySelectorAll('.appointment-card');
            
            appointments.forEach(appointment => {
                if (status === 'all' || appointment.dataset.status === status) {
                    appointment.style.display = 'block';
                } else {
                    appointment.style.display = 'none';
                }
            });
        });
    </script>
</body>
</html>